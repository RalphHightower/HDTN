<!DOCTYPE html>
<html>
<!--
 * @file index.html
 * @author  Thais Campanac <thais.c.campanac-climent@nasa.gov>
 *
 * @copyright Copyright Â© 2021 United States Government as represented by
 * the National Aeronautics and Space Administration.
 * No copyright is claimed in the United States under Title 17, U.S.Code.
 * All Other Rights Reserved.
 *
 * @section LICENSE
 * Released under the NASA Open Source Agreement (NOSA)
 * See LICENSE.md in the source root directory for more information.
 *
-->

<head>
    <meta http-equiv="Content-Type" content="charset=UTF-8, width=device-width, initial-scale=1">
    <title>HDTN BPSEC CONFIG</title>
</head>

<body>
    <div class="topnav">
        <a href="./hdtn_d3_gui/"> <span class="icon"><img src="./resources/home.svg" alt="Home icon" /></span><span
                class="title"> System View GUI</span></a>
        <a href="./index.html"><img src="./resources/statistics.svg" alt="Pie chart icon" /> Statistics</a>
        <div class="configDropdown">
            <button class="configDropBtn"><img src="./resources/config.svg" alt="Wrench icon" />Config</button>
            <div class="configContents">
                <a href="./config_page.html">System</a>
                <a href="./bpsec_page.html">BPSec</a>
            </div>
        </div>
        <a onclick="toggleModes()"><img src="./resources/sun.svg" alt="Sun icon" /></a>
    </div>
    <div class="bpsecBody">
        <div class="bpsecTitle">
            <h1 class="bpSecConfigTitle">BPSec Config</h1>
            <button class="bpSecAddPolicy" onclick="openForm()">Add Policy</button>
            <button class="bpSecAddSecurityEvent" onclick="openEventForm()">Add Security Event</button>
            <button onclick="loadNewBPSecJSON()">Load BPSec</button>
        </div>
        <div class="bpsecPolicies">
            <h2 class="bpSecPoliciesTitle">Current Policies</h2>
            <div class="bpSecList" id="listBPSecJSON" onload="showJSON()"></div>
        </div>
    </div>

    <div class="bpSecAddPolicyForm">
        <div class="formPopup" id="popupForm">
            <div class="formLayout">
                <div class="popupTitle">
                    <h2 class="popupTitle">Create New Policy</h2>
                    <button class="policyQuitBtn" onclick="closeForm()">X</button>
                </div>
                <div class="input">
                    <label>Description</label>
                    <input type="text" id="description">
                </div>
                <div class="input">
                    <label>Security Policy ID</label>
                    <input type="number" id="securityPolicyRuleID">
                </div>
                <div class="input">
                    <label>Security Role</label>
                    <select id="roleType" required>
                        <option value="acceptor">acceptor</option>
                        <option value="verifier">verifier</option>
                        <option value="source">source</option>
                    </select>
                </div>
                <div class="input">
                    <label>Security Source</label>
                    <input type="text" id="securitySource" step=".01" required>
                </div>
                <div class="input">
                    <label>Bundle Source</label>
                    <input type="text" id="bundleSource" step=".01" required>
                </div>
                <div class="input">
                    <label>Bundle Final Destination</label>
                    <input type="text" id="bundleDestination" step=".01" required>
                </div>
                <div class="input">
                    <label>Security Service</label>
                    <select id="securityService" required>
                        <option value="aes">Confidentiality - AES GCM</option>
                        <option value="sha">Integrity - HMAC SHA</option>
                    </select>
                </div>
                <div class="input">
                    <label>Security Event Reference</label>
                    <input type="text" id="securityEventId" required>
                </div>
                <div class="sourceType" id="sourceType" style="display: none; flex-direction: column;">
                    <div style="display: flex; flex-wrap: wrap;">
                        <label>Security Target Block Type</label>
                        <select id="securityTargets" multiple>
                            <option>0</option>
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                            <option>9</option>
                            <option>10</option>
                            <option>11</option>
                            <option>12</option>
                            <option>13</option>
                        </select>
                    </div>
                    <h3>Security Parameters for Source</h3>
                    <div class="aesVariant" id="aesVariantDiv"
                        style="display: flex; flex-direction: row; justify-content: space-between;">
                        <label>AES Variant</label>
                        <select id="aesVariant">
                            <option>128</option>
                            <option selected>256</option>
                        </select>
                        <div class="input">
                            <label>IV Size(Bytes)</label>
                            <select id="ivSize">
                                <option selected>12</option>
                                <option>16</option>
                            </select>
                        </div>
                    </div>
                    <div class="shaVariant" id="shaVariantDiv"
                        style="display: none; flex-direction: row; justify-content: space-between;">
                        <label>SHA Variant</label>
                        <select id="shaVariant">
                            <option>256</option>
                            <option selected>384</option>
                            <option>512</option>
                        </select>
                    </div>
                    <div class="input">
                        <label>Scope Flags</label>
                        <select id="scopeFlags">
                            <option>0</option>
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option selected>7</option>
                        </select>
                    </div>
                    <div class="input">
                        <label>Security Block CRC</label>
                        <select id="securityBlockCRC">
                            <option selected>0</option>
                            <option>16</option>
                            <option>32</option>
                        </select>
                    </div>
                </div>
                <label>Key File</label>
                <input type="file" id="keyFile" required>
                <button type="submit" onclick="checkNewPolicy()">Add Policy</button>
            </div>
        </div>

        <div class="bpsecAddSecurityEventForm">
            <div class="eventFormPopup" id="eventFormPopup">
                <div class="formLayout">
                    <div class="popupTitle">
                        <h2 class="popupTitle">Create New Event</h2>
                        <button class="policyQuitBtn" onclick="closeEventForm()">X</button>
                    </div>
                    <div class="input">
                        <label>Name of Event</label>
                        <input type="text" id="eventName" required>
                    </div>
                    <div class="input">
                        <label>Description</label>
                        <input type="text" id="eventDescription" required>
                    </div>
                    <div id="sopEvents">
                        <div class="input">
                            <label>Event ID</label>
                            <select id="eventID" required>
                                <option>sop Corrupted At Acceptor</option>
                                <option>sop Corrupted At Verifier</option>
                                <option>sop Missing At Verifier</option>
                                <option>sop Missing At Acceptor</option>
                                <option>sop Misconfigured At Acceptor</option>
                                <option>sop Misconfigured At Verifier</option>
                                <option>sop Misconfigured At Source</option>
                                <option>sop Added At Source</option>
                            </select>
                        </div>
                        <div class="input">
                            <label>Action</label>
                            <select id="eventActions" multiple required>
                                <option>Retain Security Operations BPCFs</option>
                                <option>Remove Security Operations</option>
                                <option>Remove Security Operations Target Block</option>
                                <option>Remove All Security Target Operations</option>
                                <option>Fail Bundle Forwarding</option>
                                <option>Request Bundle Storage</option>
                                <option>Report Reason Code</option>
                                <option>Override Security Target Block BPCFs</option>
                                <option>Override Security Block's BPCFs</option>
                            </select>
                        </div>
                    </div>
                    <br />
                    <span id="writeroot"></span>
                    <button onclick="addNewEvent()">Add another Event</button>
                    <button type="submit" onclick="checkEvent()">Submit</button>
                </div>
            </div>
        </div>
        <div id="sopEventsAdd" style="display: none">
            <div class="input">
                <label>Event ID</label>
                <select id="eventID" required>
                    <option>sop Corrupted At Acceptor</option>
                    <option>sop Corrupted At Verifier</option>
                    <option>sop Missing At Verifier</option>
                    <option>sop Missing At Acceptor</option>
                    <option>sop Misconfigured At Acceptor</option>
                    <option>sop Misconfigured At Verifier</option>
                    <option>sop Misconfigured At Source</option>
                    <option>sop Added At Source</option>
                </select>
            </div>
            <div class="input">
                <label>Action</label>
                <select id="eventActions" multiple required>
                    <option>Retain Security Operations BPCFs</option>
                    <option>Remove Security Operations</option>
                    <option>Remove Security Operations Target Block</option>
                    <option>Remove All Security Target Operations</option>
                    <option>Fail Bundle Forwarding</option>
                    <option>Request Bundle Storage</option>
                    <option>Report Reason Code</option>
                    <option>Override Security Target Block BPCFs</option>
                    <option>Override Security Block's BPCFs</option>
                </select>
            </div>
            <br />
            <input type="button" value="Remove review"
                onclick="this.parentNode.parentNode.removeChild(this.parentNode);" /><br /><br />
        </div>
    </div>

    <link type="text/css" rel="stylesheet" href="./css/style.css" />
    <script>
        let bpsecConfig = null;
        var createNewEvent = 0;

        var description = document.getElementById("description");
        var securityPolicyRuleID = document.getElementById("securityPolicyRuleID");
        var securitySource = document.getElementById("securitySource");
        var bundleSource = document.getElementById('bundleSource');
        var bundleDestination = document.getElementById('bundleDestination');
        var fileInput = document.getElementById("keyFile");
        var roleField = document.getElementById('roleType');
        var securityService = document.getElementById('securityService');
        var aesVariant = document.getElementById('aesVariant');
        var shaVariant = document.getElementById('sharVariant');
        var ivSize = document.getElementById('ivSize');
        var scopeFlags = document.getElementById('scopeFlags');
        var scopeCRC = document.getElementById('securityBlockCRC');
        var eventName = document.getElementById('eventName');
        var eventDescription = document.getElementById('eventDescription');
        var eventID = document.getElementById("eventID");
        var key = document.getElementById('securityEventId').value;

        var currentPolicies = { "bpsecConfigName": "myBPSecConfig", "policyRules": [], "securityFailureEventSets": [] };

        function openForm() {
            document.getElementById("popupForm").style.display = "flex";
        }

        function closeForm() {
            document.getElementById("popupForm").style.display = "none";
        }

        function openEventForm() {
            document.getElementById("eventFormPopup").style.display = "flex";
        }

        function closeEventForm() {
            if (!createNewEvent) {
                document.getElementById("eventFormPopup").style.display = "none";
            } else {
                alert("REQUIRED EVENT");
            }
        }

        function editTable(id) { }

        function removeTable(id) { }

        function showJSON() {
            console.log(currentPolicies);
            var div = document.getElementById("listBPSecJSON");
            div.innerHTML = '';
            newTable = "<table class=\"styled-table\" style=\"width:100%\"><colgroup><col style=\"width:65%\"><col style=\"width:35%\"></colgroup>"
            for (var key in currentPolicies) {
                if (Array.isArray(currentPolicies[key])) {
                    //newTable += "<caption style=\"text-align:left;padding-left:20px;text-transform:uppercase;margin-top:5px;font-size=20px;\">" + key + "</caption>";
                    //create table
                    for (var i = 0; i < currentPolicies[key].length; ++i) {
                        var newSubTable = "<table class=\"styled-table\" style=\"margin:15px 0px\"><colgroup><col style=\"width:65%\"><col style=\"width:35%\"></colgroup>";
                        for (var subKey in currentPolicies[key][i]) {
                            newSubTable += "<tr>" + "<td>" + subKey + "</td>";
                            if (isNaN(currentPolicies[key][i][subKey])) {
                                if ((typeof currentPolicies[key][i][subKey]) === 'object') {
                                    for (var j = 0; j < currentPolicies[key][i][subKey].length; ++j) {
                                        newSubTable += "<td>";
                                        for (arraySubkey in currentPolicies[key][i][subKey][j]) {
                                            console.log(arraySubkey);
                                            newSubTable += arraySubkey + " : ";
                                            newSubTable += currentPolicies[key][i][subKey][j][arraySubkey] + '<br \\ >';
                                        }
                                    }
                                    console.log("test for object")
                                } else {
                                    newSubTable += "<td>" + currentPolicies[key][i][subKey] + "</td>" + "</tr>";
                                }
                            } else {
                                newSubTable += "<td>" + (currentPolicies[key][i][subKey]).toLocaleString('en') + "</td>" + "</tr>";
                            }
                        }
                        newSubTable += "</table>";
                        newSubTable += "<button class=\"bpSecEditPolicies\" style=\"width: 40px; display: flex; justify-content: right;\" onclick=\"editTable()\">Edit</button>";
                        newSubTable += "<button class=\"bpSecEditPolicies\" style=\"width: 40px; display: flex; justify-content: right;\" onclick=\"removeTable()\">Remove</button>";
                        newTable += newSubTable;
                    }
                }
                else {
                    if (isNaN(currentPolicies[key])) {
                        var newRow = "<tr>" + "<td>" + key + "</td>" + "<td>" + currentPolicies[key] + "</td>" + "</tr>";
                    }
                    else {
                        //if data is a number, adds commas
                        var newRow = "<tr>" + "<td>" + key + "</td>" + "<td>" + (currentPolicies[key]).toLocaleString('en') + "</td>" + "</tr>";
                    }
                    newTable += newRow;
                }
            }
            newTable += "</table>";
            div.innerHTML = newTable;
        }

        var numberOfEvents = 1;
        function addNewEvent() {
            numberOfEvents++;
            var newFields = document.getElementById('sopEventsAdd').cloneNode(true);

            newFields.id = 'sopEventsAdd' + numberOfEvents;
            newFields.style.display = 'block';
            var newField = newFields.childNodes;
            for (var i = 0; i < newField.length; i++) {
                var theName = newField[i].name
                if (theName)
                    newField[i].name = theName + counter;
            }
            var insertHere = document.getElementById('writeroot');
            insertHere.parentNode.insertBefore(newFields, insertHere);
        }

        function clearEventForm() {
            eventName.value = '';
            eventDescription.value = '';
            eventID.value = '';
            document.getElementById('eventActions').value = '';
        }

        function checkEvent() {
            var allActions = getSelected('eventActions');
            var validEvent = true;

            //check that the information was filled out
            if (eventName.value === "") {
                alert("REQUIRED: Name");
                validEvent = false;
            }
            if (eventDescription.value === "") {
                alert("REQUIRED: Description");
                validEvent = false;
            }
            if (allActions.length === 0) {
                alert("REQUIRED: Actions");
                validEvent = false;
            }

            //check that the actions selected corresponds to the options within the Table for Security Events
            if (eventID.value === "sop Corrupted At Acceptor") {
                if (allActions.includes("Retain Security Operations BPCFs")) {
                    alert("Invalid Action for Acceptor!");
                    validEvent = false;
                    document.getElementById("eventActions").value = "";
                }
            }
            if (eventID.value === "sop Corrupted At Verifier") {
                if (allActions.includes("Retain Security Operations BPCFs")) {
                    alert("Invalid Action for Verifier!");
                    validEvent = false;
                    document.getElementById("eventActions").value = "";
                }
            }
            if (eventID.value === "sop Added At Source") {
                if (!allActions.includes("Override Security Block's BPCFs") && (allActions.length > 0)) {
                    alert("Invalid Action for Source!");
                    validEvent = false;
                    document.getElementById("eventActions").value = "";
                }
            }
            if ((eventID.value === "sop Missing At Verifier") || (eventID.value === "sop Missing At Acceptor")) {
                if (allActions.includes("Retain Security Operations BPCFs") || allActions.includes("Remove Security Operations") || allActions.includes("Remove All Security Target Operations") || allActions.includes("Override Security Block's BPCFs")) {
                    if (eventID.value === "sop Misconfigured At Acceptor") {
                        alert("Invalid Action for Acceptor!");
                    } else {
                        alert("Invalud Action for Verifer!");
                    }
                    validEvent = false;
                    document.getElementById("eventActions").value = "";
                }
            }
            if ((eventID.value === "sop Misconfigured At Acceptor") || (eventID.value === "sop Misconfigured At Verifier")) {
                if (allActions.includes("Retain Security Operations BPCFs") || allActions.includes("Remove All Security Target Operations")) {
                    if (eventID.value === "sop Misconfigured At Acceptor") {
                        alert("Invalid Action for Acceptor!");
                    } else {
                        alert("Invalud Action for Verifer!");
                    }
                    validEvent = false;
                    document.getElementById("eventActions").value = "";
                }
            }
            if (eventID.value === "sop Misconfigured At Source") {
                if (allActions.includes("Retain Security Operations BPCFs") || allActions.includes("Override Security Target Block BPCFs") || allActions.includes("Override Security Block's BPCFs")) {
                    alert("Invalid Action for Source!");
                    validEvent = false;
                    document.getElementById("eventActions").value = "";
                }
            }

            if (validEvent) {
                var newEvent = new Object();
                var securityOperationEvents = [];

                newEvent.name = eventName.value;
                newEvent.description = eventDescription.value;

                var eventJSON = new Object();
                eventJSON.eventId = eventID.value;
                eventJSON.actions = allActions;

                securityOperationEvents.push(eventJSON);
                newEvent.securityOperationEvents = securityOperationEvents;
                currentPolicies.securityFailureEventSets.push(newEvent);

                alert("New Event added to BPSec Config");
                eventName.removeAttribute("readonly");
                clearEventForm();
                createNewEvent = 0;
                closeEventForm();
                showJSON();
            }
        }

        function resetFormValues() {
            if (roleField.value === "source") {
                if (securityService.value === 'aes') {
                    aesVariant.value = '256';
                    ivSize.value = '12';
                } else {
                    shaVariant.value = '384';
                }

                scopeFlags.value = '7';
                scopeCRC.value = '0';
            }
            description.value = '';
            securityPolicyRuleID.value = '';
            securitySource.value = '';
            bundleSource.value = '';
            bundleDestination.value = '';
            fileInput.value = '';
            roleField.value = 'acceptor';
            securityService.value = 'aes';
        }

        function getSelected(tagName) {
            var options = document.getElementById(tagName).options,
                result = [];

            for (var i = 0, len = options.length; i < len; i++) {
                var opt = options[i];

                if (opt.selected) {
                    result.push(opt.value);
                }
            }
            return result;
        }

        function createNewPolicy() {
            var newPolicy = new Object();
            newPolicy.description = description.value;
            newPolicy.securityPolicyRuleId = securityPolicyRuleID.value;
            newPolicy.securityRole = roleField.value;
            newPolicy.securitySource = securitySource.value;
            newPolicy.bundleSource = bundleSource.value;
            newPolicy.bundleDestination = bundleDestination.value;
            newPolicy.securityFailureEventSetReference = document.getElementById('securityEventId').value;

            if (securityService.value === "aes") {
                newPolicy.securityService = 'confidentiality';
                newPolicy.securityContext = 'aesGcm';
            } else {
                newPolicy.securityService = 'integrity';
                newPolicy.securityContext = 'hmacSha';
            }

            var securityContextParams = [];
            if (roleField.value === 'source') {
                var securityTargets = getSelected("securityTargets");
                newPolicy.securityTargetBlockTypes = securityTargets;
                if (securityService.value === "aes") {
                    var newParam = {
                        "paramName": "aesVariant",
                        "value": aesVariant.value
                    }
                    securityContextParams.push(newParam);
                    var ivParam = {
                        "paramName": "ivSizeBytes",
                        "value": ivSize.value
                    }
                    securityContextParams.push(ivParam);
                } else {
                    var newParam = {
                        "paramName": "shaVariant",
                        "value": shaVariant.value
                    }
                    securityContextParams.push(newParam);
                }

                //all the following params are required for source
                var scopeParam = {
                    "paramName": "scopeFlags",
                    "value": scopeFlags.value
                }
                securityContextParams.push(scopeParam);

                var securityBlockParam = {
                    "paramName": "securityBlockCrc",
                    "value": scopeCRC.value
                }
                securityContextParams.push(securityBlockParam);
            }

            var fileParam = {
                "paramName": "keyFile",
                "value": fileInput.value
            }
            securityContextParams.push(fileParam);

            newPolicy.securityContextParams = securityContextParams;
            currentPolicies.policyRules.push(newPolicy);

            alert("New Policy Added");
            resetFormValues();
            showJSON();
            closeForm();
        }

        function checkNewPolicy(event) {
            var valid = 1;

            console.log("New Policy for a " + roleField.value);
            console.log(document.getElementById('securityEventId').value);

            //check the node ids for the policies
            var ipRegex = /\d{1,2}\.\d{1,2}[^1]|1\.1|1\.\d{1,2}|\*\.\*|1\.\*/g; //for ips of *.*, 1.*, 1.1

            if (!ipRegex.test(securitySource.value)) {
                alert('Invalid Security Source\nValid Security Source are 1.*, *.*, or 1.1')
                console.log("Error: Wrong value for security source");
                securitySource.value = '';
                valid = 0;
            }

            var ipRegex2 = /\d{1,2}\.\d{1,2}[^1]|1\.1|1\.\d{1,2}|\*\.\*|1\.\*/g; //for ips of *.*, 1.*, 1.1

            if (!ipRegex2.test(bundleSource.value)) {
                alert('Invalid Bundle Source\nValid Bundle Source are 1.*, *.*, or 1.1')
                console.log("Error: Wrong value for bundle source");
                bundleSource.value = '';
                valid = 0;
            }

            var ipRegex3 = /\d{1,2}\.\d{1,2}[^1]|1\.1|1\.\d{1,2}|\*\.\*|1\.\*/g; //for ips of *.*, 1.*, 1.1

            if (!ipRegex3.test(bundleDestination.value)) {
                alert('Invalid Bundle Destination\nValid Bundle Destination are 1.*, *.*, or 1.1')
                console.log("Error: Wrong value for bundle Destination");
                bundleDestination.value = '';
                valid = 0;
            }

            //check the file type of the form
            var filePath = fileInput.value;
            var fileRegex = /\.key$/i;
            if (!fileRegex.test(filePath)) {
                alert('Invalid file type');
                console.log("Error: Wrong File Type.");
                fileInput.value = '';
                valid = 0;
            }

            securityEventSet = currentPolicies.securityFailureEventSets;

            if (securityEventSet.length === 0) {
                createNewEvent = 1;
            } else {
                for (var el in securityEventSet) {
                    console.log(el);
                    if (securityEventSet[el].name === document.getElementById('securityEventId').value) {
                        createNewEvent = 0;
                        break;
                    }
                    createNewEvent = 1;
                }
            }

            if (createNewEvent) {
                eventName.value = document.getElementById('securityEventId').value;
                eventName.setAttribute("readonly", "true");
            }

            if (valid) {
                if (createNewEvent) {
                    openEventForm();
                }
                createNewPolicy();
            }
        }

        var sourceExtraFields = document.getElementById('sourceType');
        roleField.addEventListener('change', function () {
            if (roleField.value === "source") {
                sourceExtraFields.style.display = 'flex';
            } else {
                sourceExtraFields.style.display = 'none';
            }
        });

        var securityService = document.getElementById('securityService');
        securityService.addEventListener('change', function () {
            if (securityService.value === 'aes') {
                document.getElementById('aesVariantDiv').style.display = 'flex';
                document.getElementById('shaVariantDiv').style.display = 'none';
            } else {
                document.getElementById('shaVariantDiv').style.display = 'flex';
                document.getElementById('aesVariantDiv').style.display = 'none';
            }
        });

        function loadNewBPSecJSON() {
            let apiObj = {
                "apiCall": "bpSec",
            };
            WebSocketSend(JSON.stringify(apiObj));
        }

        var connection = null;
        window.addEventListener("load", function (event) {
            console.log("All resources finished loading!");
            if (!("WebSocket" in window)) {
                alert("WebSocket is not supported by your Browser!");
            }
            else {
                var wsproto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
                connection = new WebSocket(wsproto + '//' + window.location.host + '/websocket');
                connection.binaryType = "arraybuffer";


                //This event occurs when socket connection is established.
                connection.onopen = function () {
                    console.log("ws opened");
                    loadNewBPSecJSON();
                }

                //This event occurs when connection is closed.
                connection.onclose = function () {
                    console.log("ws closed");
                }

                //This event occurs when client receives data from server.
                connection.onmessage = function (e) {
                    if (e.data instanceof ArrayBuffer) { //this is binary data
                        console.log("binary data received.. ignoring");
                    }
                    else { //this is text data such as json
                        if (e.data === "Hello websocket") {
                            console.log(e.data);
                        }
                        else { //json data

                        }
                    }
                }

                //This event occurs when there is any error in communication.
                connection.onerror = function (error) {
                    connection.close();
                }
            } //running http(s)

        });

        function WebSocketSend(str) {
            connection.send(str);
        }
    </script>
</body>

</html>