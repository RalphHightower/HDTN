<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="charset=UTF-8, width=device-width, initial-scale=1">
    <title>HDTN BPSEC CONFIG</title>
</head>

<body>
    <div class="topnav">
        <a href="./hdtn_d3_gui/"> <span class="icon"><img src="./resources/home.svg" alt="Home icon" /></span><span
                class="title"> System View GUI</span></a>
        <a href="./index.html"><img src="./resources/statistics.svg" alt="Pie chart icon" /> Statistics</a>
        <div class="configDropdown">
            <button class="configDropBtn"><img src="./resources/config.svg" alt="Wrench icon" />Config</button>
            <div class="configContents">
                <a href="./config_page.html">System</a>
                <a href="./bpsec_page.html">BPSec</a>
            </div>
        </div>
        <a onclick="toggleModes()"><img src="./resources/sun.svg" alt="Sun icon" /></a>
    </div>
    <div class="bpsecBody">
        <div class="bpsecTitle">
            <h1 class="bpSecConfigTitle">BPSec Config</h1>
            <button class="bpSecAddPolicy" onclick="openForm()">Add Policy</button>
        </div>
        <div class="bpsecPolicies">
            <h2 class="bpSecPoliciesTitle">Current Policies</h2>
            <div class="bpSecList" id="listBPSecJSON"></div>
            <button class="bpSecEditPolicies" style="width: 40px; display: flex; justify-content: right;">Edit</button>
        </div>
    </div>

    <div class="bpSecAddPolicyForm">
        <div class="formPopup" id="popupForm">
            <div class="formLayout">
                <div class="popupTitle">
                    <h2 class="popupTitle">Create New Policy</h2>
                    <button class="policyQuitBtn" onclick="closeForm()">X</button>
                </div>
                <div class="input">
                    <label>Description</label>
                    <input type="text" id="description">
                </div>
                <div class="input">
                    <label>Security Policy ID</label>
                    <input type="number" id="securityPolicyRuleID">
                </div>
                <div class="input">
                    <label>Security Role</label>
                    <select id="roleType" required>
                        <option value="acceptor">acceptor</option>
                        <option value="verifier">verifier</option>
                        <option value="source">source</option>
                    </select>
                </div>
                <div class="input">
                    <label>Security Source</label>
                    <input type="number" id="securitySource" step=".01" required>
                </div>
                <div class="input">
                    <label>Bundle Source</label>
                    <input type="number" id="bundleSource" step=".01" required>
                </div>
                <div class="input">
                    <label>Bundle Final Destination</label>
                    <input type="number" id="bundleDestination" step=".01" required>
                </div>
                <div class="input">
                    <label>Security Service</label>
                    <select id="securityService" required>
                        <option value="aes">Confidentuality - AES GCM</option>
                        <option value="sha">Integrity - HMAC SHA</option>
                    </select>
                </div>
                <div class="sourceType" id="sourceType" style="display: none; flex-direction: column;">
                    <div class="input">
                        <label>Security Target Block Type</label>
                        <input type="range" min="0" max="13" step="1" value="0" id="targetBlockType" oninput="this.nextElementSibling.value = this.value" required>
                        <output>0</output>
                    </div>
                    <h3>Security Parameters for Source</h3>
                    <div class="aesVariant" id="aesVariantDiv"
                        style="display: flex; flex-direction: row; justify-content: space-between;">
                        <label>AES Variant</label>
                        <select id="aesVariant">
                            <option>128</option>
                            <option selected>256</option>
                        </select>
                    </div>
                    <div class="shaVariant" id="shaVariantDiv"
                        style="display: none; flex-direction: row; justify-content: space-between;">
                        <label>SHA Varient</label>
                        <select id="shaVariant">
                            <option>256</option>
                            <option selected>384</option>
                            <option>512</option>
                        </select>
                    </div>
                    <div class="input">
                        <label>IV Size(Bytes)</label>
                        <select id="ivSize">
                            <option selected>12</option>
                            <option>16</option>
                        </select>
                    </div>
                    <div class="input">
                        <label>Scope Flags</label>
                        <input type="number" min="0" max="7" value="7" id="scopeFlags">
                    </div>
                    <div class="input">
                        <label>Security Block CRC</label>
                        <select id="securityBlockCRC">
                            <option selected>0</option>
                            <option>16</option>
                            <option>32</option>
                        </select>
                    </div>
                </div>
                <label>Key File</label>
                <input type="file" id="keyFile" required>
                <button type="submit" onclick="checkNewPolicy()">Add Policy</button>
            </div>
        </div>
    </div>

    <link type="text/css" rel="stylesheet" href="./css/style.css" />

    <script type="text/javascript" src="./Scripts/jquery-3.6.0.slim.min.js"></script>
    <script>
        function openForm() {
            document.getElementById("popupForm").style.display = "flex";
        }

        function closeForm() {
            document.getElementById("popupForm").style.display = "none";

        }

        function checkNewPolicy(event) {
            console.log("New Policy for a " + roleField.value);

            //check the node ids for the policies
            var securitySource = document.getElementById("securitySource");
            var ipRegex = /\d{1,2}\.(\d{1,2}[^1])|1\.1|1\.\d{1,2}$/g; //for ips of *.*, 1.*, 1.1

            if (!ipRegex.test(securitySource.value)) {
                alert('Invalid Security Source\nValid Security Source are 1.*, *.*, or 1.1')
                console.log("Error: Wrong value for security source");
                securitySource.value = '';
            }

            var bundleSource = document.getElementById('bundleSource');
            var ipRegex2 = /\d{1,2}\.(\d{1,2}[^1])|1\.1|1\.\d{1,2}$/g; //for ips of *.*, 1.*, 1.1

            if (!ipRegex2.test(bundleSource.value)) {
                alert('Invalid Bundle Source\nValid Bundle Source are 1.*, *.*, or 1.1')
                console.log("Error: Wrong value for bundle source");
                bundleSource.value = '';
            }

            var bundleDestination = document.getElementById('bundleDestination');
            var ipRegex3 = /\d{1,2}\.(\d{1,2}[^1])|1\.1|1\.\d{1,2}$/g; //for ips of *.*, 1.*, 1.1

            if (!ipRegex3.test(bundleDestination.value)) {
                alert('Invalid Bundle Destination\nValid Bundle Destination are 1.*, *.*, or 1.1')
                console.log("Error: Wrong value for bundle Destination");
                bundleDestination.value = '';
            }

            //check the security params for security role source
            if (roleField.value === 'source') {
                var scopeFlags = document.getElementById('scopeFlags');
                if (((scopeFlags.value) % 1) != 0) {
                    alert('Invalid Scope Flag\nValid Scope Flag is whole numbers between 0-7');
                    console.log('Invalid scope flag. Decmial');
                    scopeFlags.value = '7';
                }
            }

            //check the file type of the form
            var fileInput = document.getElementById("keyFile");
            var filePath = fileInput.value;

            var fileRegex = /\.key$/i;
            if (!fileRegex.test(filePath)) {
                alert('Invalid file type');
                console.log("Error: Wrong File Type.");
                fileInput.value = '';
            }
        }

        var roleField = document.getElementById('roleType');
        var sourceExtraFields = document.getElementById('sourceType');
        roleField.addEventListener('change', function () {
            if (roleField.value === "source") {
                sourceExtraFields.style.display = 'flex';
            } else {
                sourceExtraFields.style.display = 'none';
            }
        });

        var securityService = document.getElementById('securityService');
        securityService.addEventListener('change', function () {
            if (securityService.value === 'aes') {
                console.log("switch tabs");
                document.getElementById('aesVariantDiv').style.display = 'flex';
                document.getElementById('shaVariantDiv').style.display = 'none';
            } else {
                document.getElementById('shaVariantDiv').style.display = 'flex';
                document.getElementById('aesVariantDiv').style.display = 'none';
            }
        });

        $(document).on('submit', '#form', function (event) {
            checkNewPolicy();
        });

        function createTable(json, tag) {
            var div = document.getElementById(tag);
            newTable = "<table class=\"styled-table\" style=\"width:100%\"><colgroup><col style=\"width:65%\"><col style=\"width:35%\"></colgroup>"
            for (var key in json) {
                if (Array.isArray(json[key])) {
                    //Creates subtables for each induct, outduct, and storage object
                    for (var i = 0; i < json[key].length; ++i) {
                        var newSubTable = "<table class=\"styled-table\" style=\"margin:15px 0px\"><colgroup><col style=\"width:65%\"><col style=\"width:35%\"></colgroup>";
                        for (var subKey in json[key][i]) {
                            newSubTable += "<tr>" + "<td>" + subKey + "</td>";
                            if (isNaN(json[key][i][subKey])) {
                                newSubTable += "<td>" + json[key][i][subKey] + "</td>" + "</tr>";
                            }
                            else {
                                newSubTable += "<td>" + (json[key][i][subKey]).toLocaleString('en') + "</td>" + "</tr>";
                            }
                        }
                        newSubTable += "</table>";
                        newTable += newSubTable;
                    }
                }
                else {
                    if (isNaN(json[key])) {
                        var newRow = "<tr>" + "<td>" + key + "</td>" + "<td>" + json[key] + "</td>" + "</tr>";
                    }
                    else {
                        //if data is a number, adds commas
                        var newRow = "<tr>" + "<td>" + key + "</td>" + "<td>" + (json[key]).toLocaleString('en') + "</td>" + "</tr>";
                    }
                    newTable += newRow;
                }
            }
            newTable += "</table>";
            div.innerHTML = newTable;
        }
    </script>
</body>

</html>